<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - MathMentor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    
    <style>
        .form-description {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }
        
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .message.error {
            background-color: #fee;
            color: #c00;
        }
        
        .message.success {
            background-color: #efe;
            color: #0a0;
        }

        .input-error {
            display: none;
            color: #c00;
            font-size: 12px;
            margin-top: 5px;
        }

        .input-help {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        input.error {
            border-color: #c00;
        }

        .form-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <!-- Email Verification Form -->
            <form id="emailVerificationForm" class="auth-form">
                <h2>Reset Password</h2>
                <p class="form-description">Please enter your email address to reset your password.</p>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Enter your email" required>
                    <div class="input-error"></div>
                </div>
                <button type="submit" class="btn-primary">Continue</button>
                <div class="form-links">
                    <a href="{{ url_for('auth.auth_page') }}">Back to Login</a>
                </div>
            </form>

            <!-- New Password Form (Initially Hidden) -->
            <form id="newPasswordForm" class="auth-form" style="display: none;">
                <h2>Set New Password</h2>
                <p class="form-description">Please enter your new password.</p>
                <div class="form-group">
                    <input type="password" name="new_password" placeholder="Enter new password" required 
                           minlength="6" pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$">
                    <div class="input-error"></div>
                    <small class="input-help">Password must be at least 6 characters long and contain both letters and numbers.</small>
                </div>
                <div class="form-group">
                    <input type="password" name="confirm_password" placeholder="Confirm new password" required>
                    <div class="input-error"></div>
                </div>
                <button type="submit" class="btn-primary">Reset Password</button>
                <div class="form-links">
                    <a href="{{ url_for('auth.auth_page') }}">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let verifiedEmail = '';

        // Email validation
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Password validation
        function isValidPassword(password) {
            return /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(password);
        }

        // Show input error
        function showInputError(input, message) {
            const errorDiv = input.parentElement.querySelector('.input-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            input.classList.add('error');
        }

        // Clear input error
        function clearInputError(input) {
            const errorDiv = input.parentElement.querySelector('.input-error');
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            input.classList.remove('error');
        }

        document.getElementById('emailVerificationForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const emailInput = event.target.querySelector('input[name="email"]');
            const email = emailInput.value;

            // Clear previous errors
            clearInputError(emailInput);

            // Validate email format
            if (!isValidEmail(email)) {
                showInputError(emailInput, 'Please enter a valid email address');
                return;
            }

            try {
                const response = await fetch('/api/verify-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                if (response.ok) {
                    verifiedEmail = email;
                    document.getElementById('emailVerificationForm').style.display = 'none';
                    document.getElementById('newPasswordForm').style.display = 'block';
                    showMessage('Email verified successfully', 'success');
                } else {
                    showInputError(emailInput, data.error || 'Email verification failed');
                }
            } catch (error) {
                showInputError(emailInput, 'Failed to verify email. Please try again.');
            }
        });

        document.getElementById('newPasswordForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const newPasswordInput = form.querySelector('input[name="new_password"]');
            const confirmPasswordInput = form.querySelector('input[name="confirm_password"]');
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Clear previous errors
            clearInputError(newPasswordInput);
            clearInputError(confirmPasswordInput);

            // Validate password format
            if (!isValidPassword(newPassword)) {
                showInputError(newPasswordInput, 'Password must be at least 6 characters long and contain both letters and numbers');
                return;
            }

            if (newPassword !== confirmPassword) {
                showInputError(confirmPasswordInput, 'Passwords do not match');
                return;
            }

            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email: verifiedEmail,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage('Password reset successfully!', 'success');
                    // 等待用户看到成功消息后再跳转
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    window.location.href = '{{ url_for("auth.auth_page") }}';
                } else {
                    showMessage(data.error || 'Failed to reset password', 'error');
                }
            } catch (error) {
                showMessage('Failed to reset password', 'error');
            }
        });

        function showMessage(message, type = 'error') {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            
            const currentForm = document.querySelector('.auth-form[style="display: block"]') || 
                              document.querySelector('.auth-form:not([style*="display: none"])');
            currentForm.appendChild(messageElement);
            
            if (type === 'success') {
                setTimeout(() => {
                    messageElement.remove();
                }, 3000);
            }
        }
    </script>

</body>
</html> 