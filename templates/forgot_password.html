<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - MathMentor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    
    <style>
        .form-description {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }
        
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .message.error {
            background-color: #fee;
            color: #c00;
        }
        
        .message.success {
            background-color: #efe;
            color: #0a0;
        }

        .input-error {
            display: none;
            color: #c00;
            font-size: 12px;
            margin-top: 5px;
        }

        .input-help {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        input.error {
            border-color: #c00;
        }

        .form-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <!-- Email Verification Form -->
            <form id="emailVerificationForm" class="auth-form">
                <h2>Reset Password</h2>
                <p class="form-description">Please enter your email address to reset your password.</p>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Enter your email" required>
                    <div class="input-error"></div>
                </div>
                <button type="submit" class="btn-primary">Continue</button>
                <div class="form-links">
                    <a href="{{ url_for('auth.auth_page') }}">Back to Login</a>
                </div>
            </form>

            <!-- New Password Form (Initially Hidden) -->
            <form id="newPasswordForm" class="auth-form" style="display: none;">
                <h2>Set New Password</h2>
                <p class="form-description">Please enter your new password.</p>
                <div class="form-group">
                    <input type="password" name="new_password" placeholder="Enter new password" required 
                           minlength="6" pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$">
                    <div class="input-error"></div>
                    <small class="input-help">Password must be at least 6 characters long and contain both letters and numbers.</small>
                </div>
                <div class="form-group">
                    <input type="password" name="confirm_password" placeholder="Confirm new password" required>
                    <div class="input-error"></div>
                </div>
                <button type="submit" class="btn-primary">Reset Password</button>
                <div class="form-links">
                    <a href="{{ url_for('auth.auth_page') }}">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let verifiedEmail = '';

        // Email validation
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Password validation
        function isValidPassword(password) {
            return /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(password);
        }

        // Show input error
        function showInputError(input, message) {
            const errorDiv = input.parentElement.querySelector('.input-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            input.classList.add('error');
        }

        // Clear input error
        function clearInputError(input) {
            const errorDiv = input.parentElement.querySelector('.input-error');
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            input.classList.remove('error');
        }

        // 初始化密码查看切换功能
        function initPasswordToggles() {
            const passwordInputs = document.querySelectorAll('input[type="password"]');
            
            passwordInputs.forEach(input => {
                // 如果输入框已经在容器内，不重复包装
                if (input.parentElement.classList.contains('password-input-container')) {
                    return;
                }
                
                // 创建包装容器
                const container = document.createElement('div');
                container.className = 'password-input-container';
                
                // 将输入框放入容器
                input.parentNode.insertBefore(container, input);
                container.appendChild(input);
                
                // 创建切换按钮
                const toggleBtn = document.createElement('button');
                toggleBtn.type = 'button'; // 防止在表单中提交
                toggleBtn.className = 'password-toggle';
                toggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                `;
                container.appendChild(toggleBtn);
                
                // 添加点击事件
                toggleBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // 防止表单提交
                    
                    // 切换密码可见性
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    
                    // 更改图标
                    if (type === 'password') {
                        toggleBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                        `;
                    } else {
                        toggleBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                                <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                                <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
                                <line x1="2" y1="2" x2="22" y2="22" />
                            </svg>
                        `;
                    }
                });
            });
        }

        // 在DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initPasswordToggles();
        });

        document.getElementById('emailVerificationForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const emailInput = event.target.querySelector('input[name="email"]');
            const email = emailInput.value;

            // Clear previous errors
            clearInputError(emailInput);

            // Validate email format
            if (!isValidEmail(email)) {
                showInputError(emailInput, 'Please enter a valid email address');
                return;
            }

            try {
                const response = await fetch('/api/verify-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                if (response.ok) {
                    verifiedEmail = email;
                    document.getElementById('emailVerificationForm').style.display = 'none';
                    document.getElementById('newPasswordForm').style.display = 'block';
                    showMessage('Email verified successfully', 'success');
                    // 重新初始化密码查看按钮
                    initPasswordToggles();
                } else {
                    showInputError(emailInput, data.error || 'Email verification failed');
                }
            } catch (error) {
                showInputError(emailInput, 'Failed to verify email. Please try again.');
            }
        });

        document.getElementById('newPasswordForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const newPasswordInput = form.querySelector('input[name="new_password"]');
            const confirmPasswordInput = form.querySelector('input[name="confirm_password"]');
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Clear previous errors
            clearInputError(newPasswordInput);
            clearInputError(confirmPasswordInput);

            // Validate password format
            if (!isValidPassword(newPassword)) {
                showInputError(newPasswordInput, 'Password must be at least 6 characters long and contain both letters and numbers');
                return;
            }

            if (newPassword !== confirmPassword) {
                showInputError(confirmPasswordInput, 'Passwords do not match');
                return;
            }

            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email: verifiedEmail,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage('Password reset successfully!', 'success');
                    // 等待用户看到成功消息后再跳转
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    window.location.href = '{{ url_for("auth.auth_page") }}';
                } else {
                    showMessage(data.error || 'Failed to reset password', 'error');
                }
            } catch (error) {
                showMessage('Failed to reset password', 'error');
            }
        });

        function showMessage(message, type = 'error') {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            
            const currentForm = document.querySelector('.auth-form[style="display: block"]') || 
                              document.querySelector('.auth-form:not([style*="display: none"])');
            currentForm.appendChild(messageElement);
            
            if (type === 'success') {
                setTimeout(() => {
                    messageElement.remove();
                }, 3000);
            }
        }
    </script>

</body>
</html> 